---
title: "version 1"
output: html_document
date: "2024-10-07"
---
never: hard use at O, at 0 years 
previous: years at 2, hard use at 0
current: hard use at 1, years at 2 
partial f test or critical values

correlation coeficients beween variables 
-

#some steps for commiting to git and pushing to github:
for git use getwd() function to determine pathway 
cd /home/robmcneil/Desktop/test
git branch
git checkout your-branch-name (can do this in R terminal )
git status
git push origin your-branch-name
#prof mentioned inclusion of an interaction term 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}

#read in data

library(tidyverse)
library(dplyr)
library(lme4)
library(ggplot2)
library(VIM)
library(naniar)
library(readr)
library(kableExtra)
library(finalfit)
library(broom)
library(sjPlot)
library(StepReg)
library(reshape2)
library(Amelia)
library(mice)
library(fastDummies)
library(vcd)

#linux pathway
hiv<- read_csv("/home/robmcneil/Documents/advanced_data/hiv_dataset.csv")

#windows pathway
#hiv<- read_csv("C:/Users/rrm10/OneDrive/Desktop/advanced data analysis/hiv_dataset.csv")

# Jessicas read in data
#hiv<- read_csv("~/Downloads/hiv_dataset.csv")

#check data types
str(hiv)
print(hiv)

```



```{r}
#filter dataset to two years
print(hiv)
hiv_filtered <- hiv %>%
  filter(years <= 2)
print(hiv_filtered)
```

```{r}
# Get drug use status
hiv_categorized <- hiv_filtered %>%
  group_by(newid) %>%
  mutate(drug_use_status = case_when(
    all(hard_drugs == 0) ~ "Never",
    hard_drugs[3] == 1 ~ "Current",
    hard_drugs[3] == 0 & any(hard_drugs[1:2] == 1) ~ "Previous"
  )) %>%
  
  ungroup()
  
print(hiv_categorized)

```


```{r}
#Get dummy variables for drug use status

hiv_categorized <- hiv_categorized %>%
  mutate(
    drug_use_currently = if_else(drug_use_status == "Current", 1, 0),
    drug_use_previously = if_else(drug_use_status == "Previous", 1, 0),
    drug_use_never = if_else(drug_use_status == "Never", 1, 0)
  )
print(hiv_categorized)

```


```{r}
#Turn dataswt from long to wide for missing data evaluation, so we only have one observation per subject

wide_hiv_categorized <-hiv_categorized %>%
  pivot_wider(
    id_cols = c(newid, RACE, EDUCBAS, hivpos, drug_use_status, drug_use_currently, drug_use_previously, drug_use_never),
    names_from = years,
    values_from = c(AGG_MENT, AGG_PHYS, HASHV, HASHF, income, BMI, HBP, DIAB,LIV34,KID,FRP,FP, TCHOL,TRIG,
                    LDL,DYSLIP,CESD,SMOKE,DKGRP,HEROPIATE,IDU,LEU3N,VLOAD,ADH,age, ART, everART, 
                    hard_drugs)
  )

print(wide_hiv_categorized)

```

```{r}
# Visualize what variables are missing data and how much is missing  
aggr(wide_hiv_categorized, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(wide_hiv_categorized), cex.axis=0.7, gap=3, ylab=c("Missing data","Pattern"))

vis_miss(wide_hiv_categorized)
```
```{r}
#See what percent of data is missing for non-outcome variables by drug use status
wide_hiv_categorized$TRIG_1_missing <- ifelse(is.na(wide_hiv_categorized$TRIG_1), 1, 0)
wide_hiv_categorized$LDL_1_missing <- ifelse(is.na(wide_hiv_categorized$LDL_1),1,0)
wide_hiv_categorized$TRIG_0_missing <- ifelse(is.na(wide_hiv_categorized$TRIG_0), 1, 0)
wide_hiv_categorized$LDL_2_missing <- ifelse(is.na(wide_hiv_categorized$LDL_2), 1, 0)
wide_hiv_categorized$LDL_0_missing <- ifelse(is.na(wide_hiv_categorized$LDL_0), 1, 0)
wide_hiv_categorized$TRIG_2_missing <- ifelse(is.na(wide_hiv_categorized$TRIG_2), 1, 0)
wide_hiv_categorized$TCHOL_1_missing <- ifelse(is.na(wide_hiv_categorized$TCHOL_1), 1, 0)
wide_hiv_categorized$TCHOL_0_missing <- ifelse(is.na(wide_hiv_categorized$TCHOL_0), 1, 0)
wide_hiv_categorized$TCHOL_2_missing <- ifelse(is.na(wide_hiv_categorized$TCHOL_2), 1, 0)
wide_hiv_categorized$income_2_missing <- ifelse(is.na(wide_hiv_categorized$income_2), 1, 0)
wide_hiv_categorized$income_0_missing <- ifelse(is.na(wide_hiv_categorized$income_0), 1, 0)
wide_hiv_categorized$income_1_missing <- ifelse(is.na(wide_hiv_categorized$income_1), 1, 0)
wide_hiv_categorized$BMI_2_missing <- ifelse(is.na(wide_hiv_categorized$BMI_2), 1, 0)
wide_hiv_categorized$BMI_1_missing <- ifelse(is.na(wide_hiv_categorized$BMI_1), 1, 0)
wide_hiv_categorized$HASHF_0_missing <- ifelse(is.na(wide_hiv_categorized$HASHF_0), 1, 0)
wide_hiv_categorized$VLOAD_1_missing <- ifelse(is.na(wide_hiv_categorized$VLOAD_1), 1, 0)
wide_hiv_categorized$LEU3N_1_missing <- ifelse(is.na(wide_hiv_categorized$LEU3N_1), 1, 0)
wide_hiv_categorized$HASHV_2_missing <- ifelse(is.na(wide_hiv_categorized$HASHV_2), 1, 0)
wide_hiv_categorized$HASHV_1_missing <- ifelse(is.na(wide_hiv_categorized$HASHV_1), 1, 0)
wide_hiv_categorized$BMI_0_missing <- ifelse(is.na(wide_hiv_categorized$BMI_0), 1, 0)
wide_hiv_categorized$HASHF_1_missing <- ifelse(is.na(wide_hiv_categorized$HASHF_1), 1, 0)
wide_hiv_categorized$DKGRP_1_missing <- ifelse(is.na(wide_hiv_categorized$DKGRP_1), 1, 0)
wide_hiv_categorized$DKGRP_2_missing <- ifelse(is.na(wide_hiv_categorized$DKGRP_2), 1, 0)
wide_hiv_categorized$HEROPIATE_0_missing <- ifelse(is.na(wide_hiv_categorized$HEROPIATE_0), 1, 0)
wide_hiv_categorized$HEROPIATE_1_missing <- ifelse(is.na(wide_hiv_categorized$HEROPIATE_1), 1, 0)
wide_hiv_categorized$AGG_MENT_1_missing <- ifelse(is.na(wide_hiv_categorized$AGG_MENT_1), 1, 0)
wide_hiv_categorized$AGG_PHYS_1_missing <- ifelse(is.na(wide_hiv_categorized$AGG_PHYS_1), 1, 0)


missing_demogrphic_by_drug_use_status <- wide_hiv_categorized %>%
  group_by(drug_use_status) %>%
  summarize(
    percent_missing_TRIG_1 = mean(TRIG_1_missing) * 100,
    percent_missing_LDL_1 = mean (LDL_1_missing) * 100,
    percent_missing_TRIG_0 = mean (TRIG_0_missing) *100,
    percent_missing_LDL_2 = mean (LDL_2_missing) *100,
    percent_missing_LDL_0 = mean (LDL_0_missing) *100,
    percent_missing_TRIG_2 = mean (TRIG_2_missing) *100,
    percent_missing_TCHOL_1 = mean (TCHOL_1_missing) *100,
    percent_missing_TCHOL_0 = mean(TCHOL_0_missing) * 100,
    percent_missing_TCHOL_2 = mean (TCHOL_2_missing) * 100,
    percent_missing_income_2 = mean (income_2_missing) *100,
    percent_missing_income_0 = mean (income_0_missing) *100,
    percent_missing_income_1 = mean (income_1_missing) *100,
    percent_missing_BMI_2 = mean (BMI_2_missing) *100,
    percent_missing_BMI_1 = mean (BMI_1_missing) *100,
    percent_missing_HASHF_0 = mean (HASHF_0_missing) *100,
    percent_missing_VLOAD_1 = mean(VLOAD_1_missing) * 100,
    percent_missing_LEU3N_1 = mean (LEU3N_1_missing) * 100,
    percent_missing_HASHV_2 = mean (HASHV_2_missing) *100,
    percent_missing_HASHV_1 = mean (HASHV_1_missing) *100,
    percent_missing_BMI_0 = mean (BMI_0_missing) *100,
    percent_missing_HASHF_1 = mean (HASHF_1_missing) *100,
    percent_missing_DKGRP_1 = mean (DKGRP_1_missing) *100,
    percent_missing_DKGRP_2 = mean (DKGRP_2_missing) *100,
    percent_missing_HEROPIATE_0 = mean (HEROPIATE_0_missing) *100,
    percent_missing_HEROPIATE_1 = mean (HEROPIATE_1_missing) *100,
    percent_missing_AGG_MENT_1 = mean (AGG_MENT_1_missing) *100,
    percent_missing_AGG_PHYS_1 = mean (AGG_PHYS_1_missing) *100,
  )

print(missing_demogrphic_by_drug_use_status)
```

```{r}
#see what percent of of each outcome variable is missing by drug use status group
wide_hiv_categorized$VLOAD_0_missing <- ifelse(is.na(wide_hiv_categorized$VLOAD_0), 1, 0)
wide_hiv_categorized$VLOAD_2_missing <- ifelse(is.na(wide_hiv_categorized$VLOAD_2),1,0)
wide_hiv_categorized$LEU3N_0_missing <- ifelse(is.na(wide_hiv_categorized$LEU3N_0), 1, 0)
wide_hiv_categorized$LEU3N_2_missing <- ifelse(is.na(wide_hiv_categorized$LEU3N_2), 1, 0)
wide_hiv_categorized$AGG_MENT_0_missing <- ifelse(is.na(wide_hiv_categorized$AGG_MENT_0), 1, 0)
wide_hiv_categorized$AGG_MENT_2_missing <- ifelse(is.na(wide_hiv_categorized$AGG_MENT_2), 1, 0)
wide_hiv_categorized$AGG_PHYS_0_missing <- ifelse(is.na(wide_hiv_categorized$AGG_PHYS_0), 1, 0)
wide_hiv_categorized$AGG_PHYS_2_missing <- ifelse(is.na(wide_hiv_categorized$AGG_PHYS_2), 1, 0)
wide_hiv_categorized$ADH_2_missing <- ifelse(is.na(wide_hiv_categorized$ADH_2), 1, 0)
  
missing_percent_by_drug_use_status <- wide_hiv_categorized %>%
  group_by(drug_use_status) %>%
  summarize(
    percent_missing_VLOAD_0 = mean(VLOAD_0_missing) * 100,
    percent_missing_VLOAD_2 = mean (VLOAD_2_missing) * 100,
    percent_missing_LEU3N_0 = mean (LEU3N_0_missing) *100,
    percent_missing_LEU3N_2 = mean (LEU3N_2_missing) *100,
    percent_missing_AGG_MENT_0 = mean (AGG_MENT_0_missing) *100,
    percent_missing_AGG_MENT_2 = mean (AGG_MENT_2_missing) *100,
    percent_missing_ADH_2 = mean (ADH_2_missing) *100,
    percent_missing_AGG_PHYS_0 = mean (AGG_PHYS_0_missing) *100,
    percent_missing_AGG_PHYS_2 = mean (AGG_PHYS_2_missing) *100,
  )

print(missing_percent_by_drug_use_status)
```
Important finding that outcome variables are only missing for those in the never treatment group, data is missing at random 


```{r}
#visualize data that is missing jst in the never group to look for further patterns
data_never <- wide_hiv_categorized %>%
  filter(drug_use_status == "Never")

aggr(data_never, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(data_never), cex.axis=0.7, gap=3, ylab=c("Missing data","Pattern"))

vis_miss(data_never)
```

```{r}
#visualize similarities between missingness
missing_data <- wide_hiv_categorized %>%
  filter(is.na(VLOAD_2))

print(missing_data)

gg_miss_upset(missing_data)
```


```{r}


# Filter the dataset for observations where drug_use_status == "Never"

data_previous <- wide_hiv_categorized %>%
  filter(drug_use_status == "Previous")
data_current <- wide_hiv_categorized %>%
  filter(drug_use_status == "Current")

data_never$log_vload2 <- log(data_never$VLOAD_2 +1)
data_never$log_vload0 <- log(data_never$VLOAD_0 +1)
data_previous$log_vload0 <- log(data_previous$VLOAD_0 +1)
data_previous$log_vload2 <- log(data_previous$VLOAD_2 +1)
data_current$log_vload0 <- log(data_current$VLOAD_0 +1)
data_current$log_vload2 <- log(data_current$VLOAD_2 +1)
# Loop through the numeric columns and create histograms
numeric_vars <- names(data_never)[sapply(data_never, is.numeric)]

vars <- c("VLOAD_0","VLOAD_1","VLOAD_2" )
for (var in vars) {
  # Create the histogram
  p <- ggplot(data_never, aes_string(x = var), breaks=10) +
    geom_histogram(breaks = 10, fill = "skyblue", color = "black") +
    labs(title = paste("Histogram of", var, "for Never Drug Use Status")) +
    theme_minimal()
  
  # Print each plot
  print(p)

}
hist(data_never$log_vload0, breaks = 20, main = "Histogram of Numeric Variable", xlab = "Values", ylab = "Frequency")

hist(data_never$log_vload2, breaks = 20, main = "Histogram of Numeric Variable", xlab = "Values", ylab = "Frequency")

hist(data_previous$log_vload0, breaks = 20, main = "Histogram of Numeric Variable", xlab = "Values", ylab = "Frequency")

hist(data_previous$log_vload2, breaks = 20, main = "Histogram of Numeric Variable", xlab = "Values", ylab = "Frequency")

hist(data_current$log_vload0, breaks = 20, main = "Histogram of Numeric Variable", xlab = "Values", ylab = "Frequency")

hist(data_current$log_vload2, breaks = 20, main = "Histogram of Numeric Variable", xlab = "Values", ylab = "Frequency")
```
 
```{r}
#/impute data using knn try 1 
imputed_data <- kNN(wide_hiv_categorized, variable = "VLOAD_2")
imputed_data1 <- kNN(imputed_data, variable = "VLOAD_0")
imputed_data2 <- kNN(imputed_data1, variable = "LEU3N_0")
imputed_data3 <- kNN(imputed_data2, variable = "LEU3N_2")
imputed_data4 <- kNN(imputed_data3, variable = "AGG_PHYS_0")
imputed_data5 <- kNN(imputed_data4, variable = "AGG_PHYS_2")
imputed_data6 <- kNN(imputed_data5, variable = "AGG_MENT_0")
HIV_imputed <- kNN(imputed_data6, variable = "AGG_MENT_2")
print(HIV_imputed)
```
```{r}
#impute data using knn try 2 (this one is better)
HIV_imputed1 <- kNN(wide_hiv_categorized)
print(HIV_imputed1)
```
```{r}
#choose certain variables so dataset is less overwhelming 
HIV_limited <- HIV_imputed1 %>%
  select(newid,RACE,EDUCBAS,drug_use_status,drug_use_currently,drug_use_previously,drug_use_never, AGG_MENT_0,AGG_MENT_2,AGG_PHYS_0, AGG_PHYS_2, HASHV_2, HASHF_2, income_2,  BMI_2, HBP_2, DIAB_2, LIV34_2, KID_2, FRP_2,FP_2, TCHOL_2,TRIG_2,LDL_2, DYSLIP_2, CESD_2, SMOKE_2, DKGRP_2, HEROPIATE_2, IDU_2, LEU3N_0,LEU3N_2, VLOAD_0, VLOAD_2, ADH_0, ADH_2, age_2, ART_2, everART_0)
print(HIV_limited)
```
```{r}
#Convert numeric categorical variables to character so you can get dummies 
HIV_limited[, c("RACE","EDUCBAS","HASHF_2", "income_2","HBP_2","DIAB_2","LIV34_2","KID_2", "FRP_2","FP_2","DYSLIP_2","SMOKE_2","DKGRP_2","ADH_0","ADH_2")] <- lapply(HIV_limited[,c("RACE","EDUCBAS","HASHF_2", "income_2","HBP_2","DIAB_2","LIV34_2","KID_2", "FRP_2","FP_2","DYSLIP_2","SMOKE_2","DKGRP_2","ADH_0","ADH_2")],as.character)
str(HIV_limited)
```

```{r}
#Get dummy variables
category_vars <- c("RACE","EDUCBAS","HASHF_2", "income_2","HBP_2","DIAB_2","LIV34_2","KID_2", "FRP_2","FP_2","DYSLIP_2","SMOKE_2","DKGRP_2","ADH_0","ADH_2")
for (var in category_vars) {
  HIV_limited <- dummy_cols(HIV_limited, select_columns = var, remove_first_dummy = TRUE)
}
print(HIV_limited)
```

```{r}

#code for table 1 
demographic_summary <-  HIV_limited %>% 
  group_by(drug_use_status) %>%
  summarise(
    `White, non-Hispanic (%)` = as.character(round(sum(RACE == 1, na.rm = TRUE) / n() * 100, 2)),
    `White, Hispanic (%)` = as.character(round(sum(RACE == 2, na.rm = TRUE) / n() * 100, 2)),
    `Black, non-Hispanic (%)` = as.character(round(sum(RACE == 3, na.rm = TRUE) / n() * 100, 2)),
    `Black, Hispanic (%)` = as.character(round(sum(RACE == 4, na.rm = TRUE) / n() * 100, 2)),
    `American Indian or Alaskan Native (%)` = as.character(round(sum(RACE == 5, na.rm = TRUE) / n() * 100, 2)),
    `Asian or Pacific Islander (%)` = as.character(round(sum(RACE == 6, na.rm = TRUE) / n() * 100, 2)),
    `Other (%)` = as.character(round(sum(RACE == 7, na.rm = TRUE) / n() * 100, 2)),
    `Other Hispanic (%)` = as.character(round(sum(RACE == 8, na.rm = TRUE) / n() * 100, 2)),
    `Education Level at Baseline: 8th grade or less (%)` = as.character(round(sum(EDUCBAS == 1, na.rm = TRUE) / n() * 100, 2)),
    `Education Level at Baseline: 9, 10, or 11th grade (%)` = as.character(round(sum(EDUCBAS == 2, na.rm = TRUE) / n() * 100, 2)),
    `Education Level at Baseline: 12th grade (%)` = as.character(round(sum(EDUCBAS == 3, na.rm = TRUE) / n() * 100, 2)),
    `Education Level at Baseline: At least 1 year of college - no degree (%)` = as.character(round(sum(EDUCBAS == 4, na.rm = TRUE) / n() * 100, 2)),
    `Education Level at Baseline: 4 years college / got degree (%)` = as.character(round(sum(EDUCBAS == 5, na.rm = TRUE) / n() * 100, 2)),
    `Education Level at Baseline: Some graduate work (%)` = as.character(round(sum(EDUCBAS == 6, na.rm = TRUE) / n() * 100, 2)),
    `Education Level at Baseline: post graduate degree (%)` = as.character(round(sum(EDUCBAS == 7, na.rm = TRUE) / n() * 100, 2)),
    `Individual gross income (year2): Less than $10,000 (%)` = as.character(round(sum(income_2 == 1, na.rm = TRUE) / n() * 100, 2)),
    `Individual gross income (year2): $10,000-$19,999 (%)` = as.character(round(sum(income_2 == 2, na.rm = TRUE) / n() * 100, 2)),
    `Individual gross income (year2): $20,000-29,999 (%)` = as.character(round(sum(income_2 == 3, na.rm = TRUE) / n() * 100, 2)),
    `Individual gross income (year2): $30,000-$39,999 (%)` = as.character(round(sum(income_2 == 4, na.rm = TRUE) / n() * 100, 2)),
    `Individual gross income (year2): $40,000-$49,999 (%)` = as.character(round(sum(income_2 == 5, na.rm = TRUE) / n() * 100, 2)),
    `Individual gross income (year2): $50,000-$59,999 (%)` = as.character(round(sum(income_2 == 6, na.rm = TRUE) / n() * 100, 2)),
    `Individual gross income (year2): $60,000 or more (%)` = as.character(round(sum(income_2 == 7, na.rm = TRUE) / n() * 100, 2)),
    `High Blood Pressure (year2): No (%)` = as.character(round(sum(HBP_2 == 1, na.rm = TRUE) / n() * 100, 2)),
    `High Blood Pressure (year2): Yes (%)` = as.character(round(sum(HBP_2 == 2, na.rm = TRUE) / n() * 100, 2)),
    `High Blood Pressure (year2): No, from data trajectory  (%)` = as.character(round(sum(HBP_2 == 3, na.rm = TRUE) / n() * 100, 2)),
    `High Blood Pressure (year2): Yes, from data trajectory  (%)` = as.character(round(sum(HBP_2 == 4, na.rm = TRUE) / n() * 100, 2)),
    `Diabetes (year2): No (%)` = as.character(round(sum(DIAB_2 == 1, na.rm = TRUE) / n() * 100, 2)),
    `Diabetes (year2): Yes (%)` = as.character(round(sum(DIAB_2 == 2, na.rm = TRUE) / n() * 100, 2)),
    `Diabetes (year2): No, from data trajectory  (%)` = as.character(round(sum(DIAB_2 == 3, na.rm = TRUE) / n() * 100, 2)),
    `Diabetes (year2): Yes, from data trajectory  (%)` = as.character(round(sum(DIAB_2 == 4, na.rm = TRUE) / n() * 100, 2)),
    `Liver Disease Stage 3/4 (year 2): No (%)` = as.character(round(sum(LIV34_2 == 1, na.rm = TRUE) / n() * 100, 2)),
    `Liver Disease Stage 3/4 (year 2) Yes (%)` = as.character(round(sum(LIV34_2 == 2, na.rm = TRUE) / n() * 100, 2)),
    `Kidney Disease (year 2) No (%)` = as.character(round(sum(KID_2 == 1, na.rm = TRUE) / n() * 100, 2)),
    `Kidney Disease (year 2) Yes (%)` = as.character(round(sum(KID_2 == 2, na.rm = TRUE) / n() * 100, 2)),
    `Smoking Status (year 2) Never Smoker (%)` = as.character(round(sum(SMOKE_2 == 1, na.rm = TRUE) / n() * 100, 2)),
    `Smoking Status (year 2) Former Smoker (%)` = as.character(round(sum(SMOKE_2 == 2, na.rm = TRUE) / n() * 100, 2)),
    `Smoking Status (year 2) Current Smoker (%)` = as.character(round(sum(SMOKE_2 == 3, na.rm = TRUE) / n() * 100, 2)),
    `Aggregated Mental Health - Baseline (Mean(SD))` = as.character(paste0(round(mean(AGG_MENT_0, na.rm = TRUE), 2), " (", round(sd(AGG_MENT_0, na.rm = TRUE), 2), ")")),
    `Aggregated Mental Health - Year 2 (Mean(SD))` = as.character(paste0(round(mean(AGG_MENT_2, na.rm = TRUE), 2), " (", round(sd(AGG_MENT_2, na.rm = TRUE), 2), ")")),
    `Aggregated Physical Health - Baseline (Mean(SD))` = as.character(paste0(round(mean(AGG_PHYS_0, na.rm = TRUE), 2), " (", round(sd(AGG_PHYS_0, na.rm = TRUE), 2), ")")),
    `Aggregated Physical Health - Year 2 (Mean(SD))` = as.character(paste0(round(mean(AGG_PHYS_2, na.rm = TRUE), 2), " (", round(sd(AGG_PHYS_2, na.rm = TRUE), 2), ")")),
    `BMI - Year 2 (Mean(SD))` = as.character(paste0(round(mean(BMI_2, na.rm = TRUE), 2), " (", round(sd(BMI_2, na.rm = TRUE), 2), ")")),   
    `Total Cholesterol - Year 2 (Mean(SD))` = as.character(paste0(round(mean(TCHOL_2, na.rm = TRUE), 2), " (", round(sd(TCHOL_2, na.rm = TRUE), 2), ")")), 
    `Triglycerides - Year 2 (Mean(SD))` = as.character(paste0(round(mean(TRIG_2, na.rm = TRUE), 2), " (", round(sd(TRIG_2, na.rm = TRUE), 2), ")")),
    `Depression Scale - Year 2 (Mean(SD))` = as.character(paste0(round(mean(CESD_2, na.rm = TRUE), 2), " (", round(sd(CESD_2, na.rm = TRUE), 2), ")")),
    `Number of CD4 Positive Cells - Year 0 (Mean(SD))` = as.character(paste0(round(mean(LEU3N_0, na.rm = TRUE), 2), " (", round(sd(LEU3N_0, na.rm = TRUE), 2), ")")),
    `Number of CD4 Positive Cells - Year 2 (Mean(SD))` = as.character(paste0(round(mean(LEU3N_2, na.rm = TRUE), 2), " (", round(sd(LEU3N_2, na.rm = TRUE), 2), ")")),
    `Standardized Viral Load - Year 0 (Mean(SD))` = as.character(paste0(round(mean(VLOAD_0, na.rm = TRUE), 2), " (", round(sd(VLOAD_0, na.rm = TRUE), 2), ")")),
    `Standardized Viral Load - Year 2 (Mean(SD))` = as.character(paste0(round(mean(VLOAD_2, na.rm = TRUE), 2), " (", round(sd(VLOAD_2, na.rm = TRUE), 2), ")")),
    `Adherence to Treatment - Year 2 - 100% (%)` = as.character(round(sum(ADH_2 == 1, na.rm = TRUE) / n() * 100, 2)),
    `Adherence to Treatment - Year 2 - 95-99% (%)` = as.character(round(sum(ADH_2 == 2, na.rm = TRUE) / n() * 100, 2)),
    `Adherence to Treatment - Year 2 - 75-94% (%)` = as.character(round(sum(ADH_2 == 3, na.rm = TRUE) / n() * 100, 2)),
    `Adherence to Treatment - Year 2 - <75% (%)` = as.character(round(sum(ADH_2 == 4, na.rm = TRUE) / n() * 100, 2)),
    `Age - Year 2 (Mean(SD))` = as.character(paste0(round(mean(age_2, na.rm = TRUE), 2), " (", round(sd(age_2, na.rm = TRUE), 2), ")")),
  ) %>%
  ungroup() %>%
  mutate(drug_use_status = case_when(
    drug_use_status == "Never" ~ "Never Reports Hard Drug Use",
    drug_use_status == "Previous" ~ "Previously Reports Hard Drug Use",
    drug_use_status == "Current" ~ "Currently Reports Hard Drug Use",
    ))%>%
  pivot_longer(cols = -drug_use_status, names_to = "Demographic and Health", values_to = "Value") %>%
  pivot_wider(names_from = drug_use_status, values_from = Value)

# Print the summary table
kable(demographic_summary, caption = "Table 1: Demographic and Other Characteristic Information by Drug Group")

```
```{r}
# Print the summary table 1 with lines between rows
kable(demographic_summary, caption = "Table 1: Demographic and Health Information by Drug Use Status") %>%
  kable_styling() %>%
  row_spec(0, bold = TRUE) %>% # Bold the header
  row_spec(1:nrow(demographic_summary), extra_css = "border-top: 1px solid black; border-bottom: 1px solid black;")
```


```{r}
#chi squared for drug status and VLOAD
contingency_table <- table(hiv_categorized$drug_use_status, hiv_categorized$VLOAD)

# Print the contingency table
#print(contingency_table)

# Run the Chi-squared test
chi_squared_result <- chisq.test(contingency_table)

# Print the results
print(chi_squared_result)



```


```{r}
#chi squared for drug status and LEU3N
contingency_table <- table(hiv_categorized$drug_use_status, hiv_categorized$LEU3N)

# Print the contingency table
#print(contingency_table)

# Run the Chi-squared test
chi_squared_result <- chisq.test(contingency_table)

# Print the results
print(chi_squared_result)





```
```{r}
#chi squared for drug status and AGG_PHYS
contingency_table <- table(hiv_categorized$drug_use_status, hiv_categorized$AGG_PHYS)

# Print the contingency table
#print(contingency_table)

# Run the Chi-squared test
chi_squared_result <- chisq.test(contingency_table)

# Print the results
print(chi_squared_result)



```



```{r}
#chi squared for drug status and AGG_MENT
contingency_table <- table(hiv_categorized$drug_use_status, hiv_categorized$AGG_MENT)

# Print the contingency table
#print(contingency_table)

# Run the Chi-squared test
chi_squared_result <- chisq.test(contingency_table)

# Print the results
print(chi_squared_result)



```


```{r}

#calculate change variables for physical, mental, VLOAD, and LEU3N



hiv_ltd_delta <- HIV_limited %>%
  mutate(
    LEU3N_delta = LEU3N_2 - LEU3N_0,
    VLOAD_delta = VLOAD_2 - VLOAD_0,
    AGG_MENT_delta = AGG_MENT_2 - AGG_MENT_0,
    AGG_PHYS_delta = AGG_PHYS_2 - AGG_PHYS_0
  )







```





```{r}


#Below are is a function for calcuation of change variables on the longitudinal dataset: most likely will not analyze this data frame due to lack of imputation on never group 





delta_calculations <- function(data) {
    data %>%
        filter(years %in% c(0, 2)) %>%  # Keep only years 0 and 2
        group_by(newid) %>%              # Group by newid
        summarize(
            delta_VLOAD = VLOAD[years == 0] - VLOAD[years == 2], #calc VLOAD delta
            delta_LEU3N = LEU3N[years ==2]  - LEU3N[years ==0],
            delta_ment  = AGG_MENT[years ==2] - AGG_MENT[years==0],
            delta_phys  = AGG_PHYS[years ==2] - AGG_PHYS[years==0],
            drug_use_status = first(drug_use_status),  # Get drug use status
            ADH = last(ADH),                          # Get ADH
            age = last(age), 
            HASHV = last(HASHV),
            HASHF = last(HASHF),
            income = first(income),
            BMI    = last(BMI),
            HBP    = last(HBP), 
            DIAB   = first(DIAB),
            LIV34  = first(LIV34),
            KID    = first(KID),
            FRP    = first(FRP),
            FP     = first(FP),
            TCHOL  = mean(TCHOL, na.rm = TRUE),
            TRIG   = mean(TRIG, na.rm = TRUE),
            LDL    = mean(LDL, na.rm = TRUE),
            DYSLIP = first(DYSLIP),
            CESD   = last(CESD),
            SMOKE  = last(SMOKE),
            DKGRP  = last(DKGRP),     #alchohol use
            HEROPIATE= last(HEROPIATE),
            IDU    = last (IDU),
            RACE   = first(RACE),
            EDUCBAS = last (EDUCBAS),
            hivpos  = first(hivpos),
            ART     = last(ART),
            everART = first(everART),
            
            
            
            .groups = 'drop'                           # Drop grouping
        ) 
}

# Call the function
hiv_deltas <- delta_calculations(hiv_categorized)

# View the result
print(hiv_deltas)



```




```{r}
#visualize CD4 positive cells

#test assumption of linearity 
#dont need to test for linearity with categorical variables 
#good graph for presentation 
ggplot(hiv_deltas, aes(x = factor(drug_use_status), y = delta_LEU3N, color = factor(drug_use_status))) +
  geom_boxplot() +
  stat_summary(fun = mean, geom = "point", shape = 3, size = 3, color = "black") +  # Adds mean points
  labs(
    title = "Figure Box Plot of CD4 based on Drug Usage Groups",
    x = "Drug Usage Group",
    y = "CD4",
    color = "Treatment Group"
  ) +
  theme_minimal()
```


```{r}

#for viral load outcome
#dont need to test for linearity with categorical variables 
#good graph for presentation 
ggplot(hiv_deltas, aes(x = factor(drug_use_status), y = log(delta_VLOAD), color = factor(drug_use_status))) +
  geom_boxplot() +
  stat_summary(fun = mean, geom = "point", shape = 3, size = 3, color = "black") +  # Adds mean points
  labs(
    title = "Figure Box Plot of log-transformed Viral Load based on Drug Usage Groups",
    x = "Drug Usage Group",
    y = "Log Viral Load",
    color = "Treatment Group"
  ) +
  theme_minimal()




```




```{r}
#visualize agg_ment


# Create the box plot
ggplot(hiv_deltas, aes(x = factor(drug_use_status), y = delta_ment, color = factor(drug_use_status))) +
  geom_boxplot() +
  stat_summary(fun = mean, geom = "point", shape = 3, size = 3, color = "black") +  # Adds mean points
  labs(
    title = "Box Plot of AGG_MENT Based on Drug Usage Groups",
    x = "Drug Usage Group",
    y = "AGG_MENT",
    color = "Drug Usage Group"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("Current" = "#1f78b4",   # Blue
                                  "Never" = "#33a02c",    # Green
                                  "Previous" = "#e31a1c"))  # Red






```
```{r}
#visualize agg_phys
# Create the box plot
ggplot(hiv_deltas, aes(x = factor(drug_use_status), y = delta_phys, color = factor(drug_use_status))) +
  geom_boxplot() +
  stat_summary(fun = mean, geom = "point", shape = 3, size = 3, color = "black") +  # Adds mean points
  labs(
    title = "Box Plot of AGG_Phys Based on Drug Usage Groups",
    x = "Drug Usage Group",
    y = "AGG_MENT",
    color = "Drug Usage Group"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("Current" = "#1f78b4",   # Blue
                                  "Never" = "#33a02c",    # Green
                                  "Previous" = "#e31a1c"))  # Red





```
```{r}

#create correlation matrix 

hiv_filtered_c <- hiv_filtered %>%
  na.omit()
correlation_matrix <-cor(hiv_filtered_c)
print(correlation_matrix)
#heropialte (took heroine or opiates since last visit) and IDU (took drugs with a needle) are highly correlated with hard_drugs



```


```{r}

#simple linear regression models. rework to set never as the reference group
#unique(hiv_deltas$drug_use_status) 

# Linear model for T-Cell Count
lm_LEU3N <- lm(LEU3N_delta ~ drug_use_currently + drug_use_previously, data = hiv_ltd_delta)
summary(lm_LEU3N)
confint(lm_LEU3N, level = 0.95)

# SLR for log-transformed Viral Load
lm_vload <- lm(log(VLOAD_delta + 1) ~ drug_use_currently + drug_use_previously, data = hiv_ltd_delta)
summary(lm_vload)
confint(lm_vload, level = 0.95)  # Use the correct model for confidence intervals

# SLR for aggregated physical health
lm_phys <- lm(AGG_PHYS_delta ~ drug_use_currently + drug_use_previously, data = hiv_ltd_delta)
summary(lm_phys)
confint(lm_phys)

# SLR for aggregated mental health
lm_mental <- lm(AGG_MENT_delta ~ drug_use_currently + drug_use_previously, data = hiv_ltd_delta)
summary(lm_mental)
confint(lm_mental)
```

```{r}

#calculate residuals and fitted values, of my models 

LEU3N_fitted<- predict(lm_result)
LEU3N_resid <-  resid(lm_result)

vload_fitted <- predict(lm_vload)
vload_resid <- resid(lm_vload)

phys_fitted <- predict(lm_phys)
phys_resid <- resid(lm_phys)


ment_fitted <- predict(lm_mental)
ment_resid  <- fitted(lm_mental)

 


```


```{r}

# Plot Residuals vs Fitted LEU3N  (Homoscedasticity)
ggplot(data = NULL, aes(x = LEU3N_fitted, y = LEU3N_resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Figure 1: CD4 T-cells Residuals vs Fitted", 
       x = "Fitted Values",
       y = "Residuals") +
  theme_minimal()



#plot residuals vs fitted for Viral Load
ggplot(data = NULL, aes(x = vload_fitted, y = vload_resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Figure 2: Viral load Residuals vs Fitted", 
       x = "Fitted Values",
       y = "Residuals") +
  theme_minimal()

#plot residuals for Physical 
ggplot(data = NULL, aes(x = phys_fitted, y = phys_resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Figure 3: Physical Health Measurement Residuals vs Fitted", 
       x = "Fitted Values",
       y = "Residuals") +
  theme_minimal()


ggplot(data = NULL, aes(x = ment_fitted, y = ment_resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Figure 3: PMental Health Measurement Residuals vs Fitted", 
       x = "Fitted Values",
       y = "Residuals") +
  theme_minimal()

```
Check Normality
```{r}

# Histogram of original VLOAD_delta
ggplot(hiv_ltd_delta, aes(x = VLOAD_delta)) +
  geom_histogram(bins = 30, fill = "blue", color = "white") +
  labs(title = "Histogram of Original Viral Load Data",
       x = "Viral Load",
       y = "Frequency") +
  theme_minimal()

#original data points are skewed, justifies log-transform

# Histogram of LEU3N
ggplot(hiv_ltd_delta, aes(x = LEU3N_delta)) +
  geom_histogram(bins = 30, fill = "blue", color = "white") +
  labs(title = "Histogram of T-cell Change Data Points",
       x = "T-Cell Count",
       y = "Frequency") +
  theme_minimal()

# Histogram of Agg_Phys
ggplot(hiv_ltd_delta, aes(x = AGG_PHYS_delta)) +
  geom_histogram(bins = 30, fill = "blue", color = "white") +
  labs(title = "Histogram of Aggregated Physical Health Distribution",
       x = "Physical Health Change",
       y = "Frequency") +
  theme_minimal()

#Histogram of Agg_ment

ggplot(hiv_ltd_delta, aes(x = AGG_MENT_delta)) +
  geom_histogram(bins = 30, fill = "blue", color = "white") +
  labs(title = "Histogram of Aggregated Mental Health Distribution",
       x = "Mental Health",
       y = "Frequency") +
  theme_minimal()



```

```{r}
#qq Plots

# Q-Q Plot for T-Cell Count
qqnorm(lm_LEU3N$residuals, main = "Q-Q Plot of Residuals for T-Cell Count")
qqline(lm_LEU3N$residuals, col = "red")

# Q-Q Plot for log-transformed Viral Load
qqnorm(lm_vload$residuals, main = "Q-Q Plot of Residuals for Viral Load")
qqline(lm_vload$residuals, col = "red")

# Q-Q Plot for Aggregated Physical Health
qqnorm(lm_phys$residuals, main = "Q-Q Plot of Residuals for Aggregated Physical Health")
qqline(lm_phys$residuals, col = "red")

# Q-Q Plot for Aggregated Mental Health
qqnorm(lm_mental$residuals, main = "Q-Q Plot of Residuals for Aggregated Mental Health")
qqline(lm_mental$residuals, col = "red")



```


```{r}


# Fit the MANOVA model
manova_model <- manova(cbind(LEU3N, VLOAD) ~ hard_drugs, data = hiv_filtered)

# Summarize the MANOVA model
summary(manova_model)


summary(manova_model, test = "Pillai") 

```




```{r}
#perform stepwise regression for model selection 
# Remove rows with NA values in the relevant columns
hiv_clean <- hiv_filtered %>%
  na.omit

# Define the formula for LEU3N (saturated)
LEU3N_formula <- LEU3N ~ hard_drugs + IDU+HEROPIATE+ age + EDUCBAS + RACE + ADH +DKGRP + SMOKE + CESD + DYSLIP +LDL +TRIG+ TCHOL +FP+FRP+KID+LIV34+DIAB+HBP+BMI+income+HASHF

# Perform stepwise regression for attachment on the cleaned data
stepwise_model <- stepwise(formula = LEU3N_formula,
                                   data = hiv_clean,
                                   type = "linear",
                                   include = c('hard_drugs'), # Adjust as needed
                                   strategy = "bidirection",
                                   metric = c("AIC", "BIC"))

# view stepwise model
stepwise_model


```



```{r}

test_model <- lm(LEU3N~ hard_drugs +age, data= hiv_clean)

test_model_i <- lm(LEU3N ~ hard_drugs *age, data =hiv_clean)

summary(test_model)
summary(test_model_i)

```








