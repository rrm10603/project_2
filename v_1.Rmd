---
title: "version 1"
output: html_document
date: "2024-10-07"
---
never: hard use at O, at 0 years 
previous: years at 2, hard use at 0
current: hard use at 1, years at 2 
partial f test or critical values

correlation coeficients beween variables 
-

#some steps for commiting to git and pushing to github:
for git use getwd() function to determine pathway 
cd /home/robmcneil/Desktop/test
git branch
git checkout your-branch-name (can do this in R terminal )
git status
git push origin your-branch-name
#prof mentioned inclusion of an interaction term 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}

#read in data

library(tidyverse)
library(dplyr)
library(lme4)
library(ggplot2)
library(VIM)
library(naniar)
library(readr)
library(kableExtra)
library(finalfit)
library(broom)
library(sjPlot)
library(StepReg)
library(reshape2)
library(Amelia)
library(mice)
library(fastDummies)

#linux pathway
#hiv<- read_csv("/home/robmcneil/Documents/advanced_data/hiv_dataset.csv")

#windows pathway
#hiv<- read_csv("C:/Users/rrm10/OneDrive/Desktop/advanced data analysis/hiv_dataset.csv")

# Jessicas read in data
hiv<- read_csv("~/Downloads/hiv_dataset.csv")

#check data types
str(hiv)
print(hiv)

```



```{r}
#filter dataset to two years
print(hiv)
hiv_filtered <- hiv %>%
  filter(years <= 2, hivpos ==1)
print(hiv_filtered)
```

```{r}
# Get drug use status
hiv_categorized <- hiv_filtered %>%
  group_by(newid) %>%
  mutate(drug_use_status = case_when(
    all(hard_drugs == 0) ~ "Never",
    hard_drugs[3] == 1 ~ "Current",
    hard_drugs[3] == 0 & any(hard_drugs[1:2] == 1) ~ "Previous"
  )) %>%
  
  ungroup()
  
print(hiv_categorized)

```

```{r}
#Get dummy variables for drug use status

hiv_categorized <- hiv_categorized %>%
  mutate(
    drug_use_currently = if_else(drug_use_status == "Current", 1, 0),
    drug_use_previously = if_else(drug_use_status == "Previous", 1, 0),
    drug_use_never = if_else(drug_use_status == "Never", 1, 0)
  )
print(hiv_categorized)

```


```{r}

# Get summary of missing values in each variable
naniar::miss_var_summary(hiv_categorized)

# Visualize missing data as a heatmap
naniar::gg_miss_var(hiv_categorized) # missing values by variable
naniar::gg_miss_upset(hiv_categorized) # visualize combinations of missing values


md.pattern(hiv_categorized)


```

```{r}

# Assuming your dataset is named 'your_data' and has 'id' and 'year' columns
# Step 1: Count the number of observations per patient
patient_observation_counts <- hiv_categorized %>%
  group_by(newid) %>%
  summarise(n_observations = n())

# Step 2: Find patients with fewer than 3 or more than 3 observations
patients_missing_obs <- patient_observation_counts %>%
  filter(n_observations != 3)

# Display patients with missing follow-ups
patients_missing_obs

#all patients at least have all three years recorded even if they are missing certain variables so that is good 

```


```{r}
aggr(hiv_categorized, col = c('navyblue','yellow'), numbers = TRUE, sortVars = TRUE)

# Using naniar to visualize missing data
gg_miss_var(hiv_categorized)
```

```{r}
# NOt WORKING BECAUSE THEY WERE PUT INTO NUMBERS FIX LATER 
hiv_dummy <- dummy_cols(hiv_categorized, select_columns = "RACE", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "EDUCBAS", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "income", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "SMOKE", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "DKGRP", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "HEROPIATE", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "SYPHA", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "HERLV", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "GONOR", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "HASHF", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "HLTPFR", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "PAINR", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "GNHLHR", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "EMTWBR", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "ENFATR", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "SOCFCR", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "KID", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "LIV34", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "FRP", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "FP", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "HBP", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "DYSLIP", remove_first_dummy = TRUE)
hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "DIAB", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "HCSTV", remove_first_dummy = TRUE)
#hiv_dummy <- dummy_cols(hiv_dummy, select_columns = "HBSTV", remove_first_dummy = TRUE)
print(hiv_dummy)
```
```{r}
#chi squared for drug status and ADH
contingency_table <- table(hiv_categorized$drug_use_status, hiv_categorized$ADH)

# Print the contingency table
print(contingency_table)

# Run the Chi-squared test
chi_squared_result <- chisq.test(contingency_table)

# Print the results
print(chi_squared_result)
```
```{r}
#chi squared for drug status and VLOAD
contingency_table <- table(hiv_categorized$drug_use_status, hiv_categorized$VLOAD)

# Print the contingency table
#print(contingency_table)

# Run the Chi-squared test
chi_squared_result <- chisq.test(contingency_table)

# Print the results
print(chi_squared_result)
```
```{r}
#chi squared for drug status and LEU3N
contingency_table <- table(hiv_categorized$drug_use_status, hiv_categorized$LEU3N)

# Print the contingency table
#print(contingency_table)

# Run the Chi-squared test
chi_squared_result <- chisq.test(contingency_table)

# Print the results
print(chi_squared_result)
```
```{r}
#chi squared for drug status and AGG_PHYS
contingency_table <- table(hiv_categorized$drug_use_status, hiv_categorized$AGG_PHYS)

# Print the contingency table
#print(contingency_table)

# Run the Chi-squared test
chi_squared_result <- chisq.test(contingency_table)

# Print the results
print(chi_squared_result)
```
```{r}
#chi squared for drug status and AGG_MENT
contingency_table <- table(hiv_categorized$drug_use_status, hiv_categorized$AGG_MENT)

# Print the contingency table
#print(contingency_table)

# Run the Chi-squared test
chi_squared_result <- chisq.test(contingency_table)

# Print the results
print(chi_squared_result)
```


```{r}
# Check for variables with missing values
missing_vars <- colnames(hiv_categorized)[colSums(is.na(hiv_categorized)) > 0]

# Loop through the variables with missing values and compare means with respect to missingness
for (var in missing_vars) {
  # Ensure the variable is numeric before running t.test
  if (is.numeric(hiv_categorized[[var]])) {
    cat("Variable:", var, "\n")
    test_result <- t.test(hiv_categorized[[var]] ~ is.na(hiv_categorized[[var]]))
    print(test_result)
    cat("\n")
  } else {
    cat("Variable:", var, "is not numeric. Skipping...\n\n")
  }
}

```
```{r}
# Create a data frame to hold the missingness indicators
missingness_data <- hiv_categorized %>%
  summarise(across(everything(), ~ as.numeric(is.na(.)), .names = "{.col}_missing"))  # Create missingness indicators

# Combine the original data and missingness indicators
combined_data <- bind_cols(hiv_categorized, missingness_data)

# Calculate correlation coefficients between original variables and their missingness indicators
correlation_results <- sapply(names(hiv_categorized), function(var) {
  if (is.numeric(combined_data[[var]])) {
    cor(combined_data[[var]], combined_data[[paste0(var, "_missing")]], use = "complete.obs")
  } else {
    NA  # Non-numeric variables will return NA
  }
})

# Create a data frame to display the results
correlation_df <- data.frame(Variable = names(hiv_categorized), Correlation = correlation_results)

# Print the correlation results
print(correlation_df)

```


```{r}



delta_calculations <- function(data) {
    data %>%
        filter(years %in% c(0, 2)) %>%  # Keep only years 0 and 2
        group_by(newid) %>%              # Group by newid
        summarize(
            delta_VLOAD = VLOAD[years == 0] - VLOAD[years == 2], #calc VLOAD delta
            delta_LEU3N = LEU3N[years ==2]  - LEU3N[years ==0],
            delta_ment  = AGG_MENT[years ==2] - AGG_MENT[years==0],
            delta_phys  = AGG_PHYS[years ==2] - AGG_PHYS[years==0],
            drug_use_status = first(drug_use_status),  # Get drug use status
            ADH = last(ADH),                          # Get ADH
            age = last(age), 
            HASHV = last(HASHV),
            HASHF = last(HASHF),
            income = first(income),
            BMI    = last(BMI),
            HBP    = last(HBP), 
            DIAB   = first(DIAB),
            LIV34  = first(LIV34),
            KID    = first(KID),
            FRP    = first(FRP),
            FP     = first(FP),
            TCHOL  = mean(TCHOL, na.rm = TRUE),
            TRIG   = mean(TRIG, na.rm = TRUE),
            LDL    = mean(LDL, na.rm = TRUE),
            DYSLIP = first(DYSLIP),
            CESD   = last(CESD),
            SMOKE  = last(SMOKE),
            DKGRP  = last(DKGRP),     #alchohol use
            HEROPIATE= last(HEROPIATE),
            IDU    = last (IDU),
            RACE   = first(RACE),
            EDUCBAS = last (EDUCBAS),
            hivpos  = first(hivpos),
            ART     = last(ART),
            everART = first(everART),
            
            
            
            .groups = 'drop'                           # Drop grouping
        ) 
}

# Call the function
hiv_deltas <- delta_calculations(hiv_categorized)

# View the result
print(hiv_deltas)



```







#```{r}
#examine missing data, code example from gum treatment project

gum$attach1yr_missing <- ifelse(is.na(gum$attach1year), 1, 0)
gum$pd1yr_missing <- ifelse(is.na(gum$pd1year),1,0)

# Find the percent of each treatent group that has missing follow up data 
missing_percentage_table_by_trtgroup <- gum %>%
  group_by(trtgroup) %>%
  summarize(
    percent_missing_attach = mean(attach1yr_missing) * 100,
    percent_missing_pd = mean (pd1yr_missing) * 100)

print(missing_percentage_table_by_trtgroup)



#```

```{r}
#visualize CD4 positive cells

#test assumption of linearity 
#dont need to test for linearity with categorical variables 
#good graph for presentation 
ggplot(hiv_filtered, aes(x = factor(hard_drugs), y = LEU3N, color = factor(hard_drugs))) +
  geom_boxplot() +
  stat_summary(fun = mean, geom = "point", shape = 3, size = 3, color = "black") +  # Adds mean points
  labs(
    title = "Figure Box Plot of CD4 based on Drug Usage Groups",
    x = "Drug Usage Group",
    y = "CD4",
    color = "Treatment Group"
  ) +
  theme_minimal()
```


```{r}

#for viral load outcome
#dont need to test for linearity with categorical variables 
#good graph for presentation 
ggplot(hiv_filtered, aes(x = factor(hard_drugs), y = VLOAD, color = factor(hard_drugs))) +
  geom_boxplot() +
  stat_summary(fun = mean, geom = "point", shape = 3, size = 3, color = "black") +  # Adds mean points
  labs(
    title = "Figure Box Plot of CD4 based on Drug Usage Groups",
    x = "Drug Usage Group",
    y = "Viral Load",
    color = "Treatment Group"
  ) +
  theme_minimal()




```

```{r}

#create correlation matrix 

hiv_filtered_c <- hiv_filtered %>%
  na.omit()
correlation_matrix <-cor(hiv_filtered_c)
print(correlation_matrix)
#heropialte (took heroine or opiates since last visit) and IDU (took drugs with a needle) are highly correlated with hard_drugs



```






```{r}

#simple linear regression for CD4 + tcell count

lm_LEU3N <- lm(LEU3N ~ hard_drugs, data = hiv_filtered)
summary(lm_result)

#slr for viral load 

lm_vload <- lm(VLOAD ~ hard_drugs, data= hiv_filtered)
summary(lm_vload)

#need to include confidence intervals
```

```{r}

#calculate residuals and fitted values, of my models 

LEU3N_fitted<- predict(lm_result)
LEU3N_resid <-  resid(lm_result)

vload_fitted <- predict(lm_vload)
vload_resid <- resid(lm_vload)

 


```


```{r}

# Plot Residuals vs Fitted LEU3N  (Homoscedasticity)
ggplot(data = NULL, aes(x = LEU3N_fitted, y = LEU3N_resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Figure 1: CD4 T-cells Residuals vs Fitted", 
       x = "Fitted Values",
       y = "Residuals") +
  theme_minimal()



#plot residuals vs fitted for Viral Load
ggplot(data = NULL, aes(x = vload_fitted, y = vload_resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Figure 2: Viral load Residuals vs Fitted", 
       x = "Fitted Values",
       y = "Residuals") +
  theme_minimal()

```


```{r}


# Fit the MANOVA model
manova_model <- manova(cbind(LEU3N, VLOAD) ~ hard_drugs, data = hiv_filtered)

# Summarize the MANOVA model
summary(manova_model)


summary(manova_model, test = "Pillai") 

```




```{r}
#perform stepwise regression for model selection 
# Remove rows with NA values in the relevant columns
hiv_clean <- hiv_filtered %>%
  na.omit

# Define the formula for LEU3N (saturated)
LEU3N_formula <- LEU3N ~ hard_drugs + IDU+HEROPIATE+ age + EDUCBAS + RACE + ADH +DKGRP + SMOKE + CESD + DYSLIP +LDL +TRIG+ TCHOL +FP+FRP+KID+LIV34+DIAB+HBP+BMI+income+HASHF

# Perform stepwise regression for attachment on the cleaned data
stepwise_model <- stepwise(formula = LEU3N_formula,
                                   data = hiv_clean,
                                   type = "linear",
                                   include = c('hard_drugs'), # Adjust as needed
                                   strategy = "bidirection",
                                   metric = c("AIC", "BIC"))

# view stepwise model
stepwise_model


```



```{r}

test_model <- lm(LEU3N~ hard_drugs +age, data= hiv_clean)

test_model_i <- lm(LEU3N ~ hard_drugs *age, data =hiv_clean)

summary(test_model)
summary(test_model_i)

```




